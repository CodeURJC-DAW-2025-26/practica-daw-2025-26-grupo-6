{{>header}}

<main class="main">
  <section id="quote" class="quote section">
    <div class="container" data-aos="fade-up" data-aos-delay="100">
      <div class="row justify-content-center">
        <h4>Solicitudes pendientes:</h4>
        <div class="row gy-4">
          {{#events}}

          <div class="col-lg-4 col-md-6" data-aos="fade-up" data-aos-delay="100">

            <div class="project-card">
              <a class="d-block text-decoration-none" href="/event/{{eventId}}">
                <div class="project-image">
                  <img src="/images/{{eventImage.id}}" alt="Project" class="img-fluid">
                </div>
                <div class="project-info">
                  <div class="project-category">{{eventTag}}</div>
                  <h4 class="project-title">{{eventName}}</h4>
                  <p class="text-muted" style="min-height: 3em; overflow: hidden; text-overflow: ellipsis;">
                    {{eventDescription}}
                  </p>
                </div>
              </a>

              <div class="d-flex gap-2 mt-2">
                <form method="post" action="/admin/approveEvent/{{eventId}}"
                  onsubmit="return confirmApprove('{{eventName}}')">
                  <input type="hidden" name="_csrf" value="{{token}}">
                  <button type="submit" class="btn btn-success rounded-pill px-3">
                    Aceptar
                  </button>
                </form>
                <form method="post" action="/admin/rejectEvent/{{eventId}}"
                  onsubmit="return confirmReject('{{eventName}}')">
                  <input type="hidden" name="_csrf" value="{{token}}">
                  <button type="submit" class="btn btn-danger rounded-pill px-3">
                    Rechazar
                  </button>
                </form>

              </div>
            </div>
          </div>
          {{/events}}

          <!--Falta darle diseño a este mensaje-->
          {{^events}}
          <div>No hay Solicitudes</div>
          {{/events}}
        </div>
      </div>
      <br>
      <br>
      <!--No se que quereis de mustache aqui, luego se mira-->
      <div class="row justify-content-center">
        <h3>Estadísticas:</h3>
        <div class="row gy-4">
          <h5>Juegos con más favoritos:</h5>

          <div class="col-12 col-lg-8" style="min-height: 320px;">
            <canvas id="gamesFavChart" height="120" aria-label="Gráfica de juegos con más favoritos"></canvas>
          </div>
        </div>
        <div class="row gy-4 mt-4">
          <h5>Eventos con más participantes:</h5>
          <div class="col-12 col-lg-8" style="min-height: 320px;">
            <canvas id="eventsParticipantsChart" height="120"></canvas>
          </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

        <script>
          document.addEventListener("DOMContentLoaded", async () => {
            const canvas = document.getElementById("gamesFavChart");
            if (!canvas) return;

            try {
              const response = await fetch("/admin/api/top-favorite-games", {
                headers: { "Accept": "application/json" }
              });

              if (!response.ok) throw new Error("Error HTTP " + response.status);

              const data = await response.json();

              const labels = data.map(d => d.gameName);
              const values = data.map(d => d.favCount);

              new Chart(canvas, {
                type: "bar",
                data: {
                  labels: labels,
                  datasets: [{
                    label: "Nº de usuarios que lo tienen en favoritos",
                    data: values,
                    backgroundColor: "rgba(54, 162, 235, 0.45)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 1,
                    borderRadius: 6
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  aspectRatio: 2.4,
                  scales: {
                    y: {
                      beginAtZero: true,
                      ticks: { precision: 0 },
                      title: { display: true, text: "Usuarios" }
                    },
                    x: {
                      ticks: { autoSkip: false, maxRotation: 30, minRotation: 0 }
                    }
                  }
                }
              });

            } catch (error) {
              console.error("Error cargando gráfica:", error);
              canvas.parentElement.innerHTML =
                '<div class="alert alert-warning">No se pudo cargar la gráfica.</div>';
            }
          });
        </script>
        <script>
          document.addEventListener("DOMContentLoaded", async () => {
            const canvas = document.getElementById("eventsParticipantsChart");
            if (!canvas) return;

            const res = await fetch("/admin/api/top-events-participants", { headers: { "Accept": "application/json" } });
            if (!res.ok) {
              canvas.parentElement.innerHTML = '<div class="alert alert-warning">No se pudo cargar la gráfica de eventos.</div>';
              return;
            }

            const data = await res.json();
            const labels = data.map(d => d.eventName);
            const values = data.map(d => d.participantCount);

            new Chart(canvas, {
              type: "bar",
              data: {
                labels,
                datasets: [{
                  label: "Nº de participantes",
                  data: values,
                  backgroundColor: "rgba(255, 159, 64, 0.45)",
                  borderColor: "rgba(255, 159, 64, 1)",
                  borderWidth: 1,
                  borderRadius: 6
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                aspectRatio: 2.4,
                scales: {
                  y: { beginAtZero: true, ticks: { precision: 0 }, title: { display: true, text: "Usuarios" } },
                  x: { ticks: { autoSkip: false, maxRotation: 30, minRotation: 0 } }
                }
              }
            });
          });
        </script>
      </div>
  </section>
  <script>
    function confirmApprove(name) {
      return confirm(`¿Aprobar el evento "${name}"?`);
    }
    function confirmReject(name) {
      return confirm(`¿Rechazar (eliminar) el evento "${name}"? Esta acción no se puede deshacer.`);
    }
  </script>
</main>

<footer id="footer" class="footer dark-background">
  <!-- Poner algo en footer (Redes de la asociación o lo q sea) -->
  <div class="footer-bottom">
    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="footer-bottom-content">
            <p class="mb-0"><span class="sitename">La Caverna Del Dragón</span></p>
            <div class="credits">
              Desarrollo de Aplicaciones Web - Grupo 6 - 2026
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {{>footer}}